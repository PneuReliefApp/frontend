name: EAS Build - Android APK

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

  push:
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      profile:
        description: 'EAS Build Profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

concurrency:
  group: eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')) ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build profile
        id: build-profile
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Generate build metadata
        id: build-meta
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="1.0.0-build.${BUILD_NUMBER}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Update app version for production
        if: steps.build-profile.outputs.profile == 'production'
        run: |
          VERSION="${{ steps.build-meta.outputs.version }}"
          BUILD_NUMBER="${{ steps.build-meta.outputs.build-number }}"

          node -e "
          const fs = require('fs');
          const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
          appJson.expo.version = '${VERSION}'.replace('v', '');
          appJson.expo.android.versionCode = parseInt('${BUILD_NUMBER}');
          fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
          "

      - name: Build Android APK with EAS
        id: eas-build
        run: |
          eas build \
            --platform android \
            --profile ${{ steps.build-profile.outputs.profile }} \
            --non-interactive \
            --no-wait \
            --json > build-output.json

          BUILD_ID=$(cat build-output.json | jq -r '.[0].id')
          BUILD_URL=$(cat build-output.json | jq -r '.[0].logsUrl')
          echo "build-id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "build-url=${BUILD_URL}" >> $GITHUB_OUTPUT
          echo "::notice::Build started with ID: ${BUILD_ID}"
          echo "::notice::Build logs: ${BUILD_URL}"

      - name: Wait for build completion
        id: build-wait
        timeout-minutes: 30
        run: |
          BUILD_ID="${{ steps.eas-build.outputs.build-id }}"
          echo "Waiting for build ${BUILD_ID} to complete..."

          while true; do
            STATUS=$(eas build:view ${BUILD_ID} --json | jq -r '.status')
            echo "Current status: ${STATUS}"

            case ${STATUS} in
              "finished")
                echo "Build completed successfully!"
                ARTIFACT_URL=$(eas build:view ${BUILD_ID} --json | jq -r '.artifacts.buildUrl')
                echo "artifact-url=${ARTIFACT_URL}" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "errored"|"canceled")
                echo "::error::Build failed with status: ${STATUS}"
                exit 1
                ;;
              "in-queue"|"in-progress")
                echo "Build in progress, waiting 30 seconds..."
                sleep 30
                ;;
              *)
                echo "Unknown status: ${STATUS}"
                sleep 30
                ;;
            esac
          done

      - name: Download APK
        if: success()
        run: |
          ARTIFACT_URL="${{ steps.build-wait.outputs.artifact-url }}"
          APK_NAME="pneurelief-${{ steps.build-profile.outputs.profile }}-${{ steps.build-meta.outputs.short-sha }}.apk"

          curl -L -o "${APK_NAME}" "${ARTIFACT_URL}"

          if [ -f "${APK_NAME}" ]; then
            SIZE=$(du -h "${APK_NAME}" | cut -f1)
            echo "::notice::APK downloaded successfully (${SIZE})"
          else
            echo "::error::Failed to download APK"
            exit 1
          fi

      - name: Upload APK to GitHub
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pneurelief-android-${{ steps.build-profile.outputs.profile }}-${{ steps.build-meta.outputs.short-sha }}
          path: "*.apk"
          retention-days: 30
          if-no-files-found: error

      # - name: Create GitHub Release
      #   if: success() && startsWith(github.ref, 'refs/tags/v')
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     files: "*.apk"
      #     generate_release_notes: true
      #     draft: false
      #     prerelease: false
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildUrl = '${{ steps.eas-build.outputs.build-url }}';
            const artifactUrl = '${{ steps.build-wait.outputs.artifact-url }}';
            const profile = '${{ steps.build-profile.outputs.profile }}';
            const version = '${{ steps.build-meta.outputs.version }}';

            const comment = `## ðŸ¤– Android Build Complete

            **Profile:** \`${profile}\`
            **Version:** \`${version}\`
            **Commit:** \`${{ steps.build-meta.outputs.short-sha }}\`

            ### ðŸ“¦ Download APK
            [Download from EAS](${artifactUrl})

            ### ðŸ“‹ Build Details
            [View Build Logs](${buildUrl})

            **Note:** APK is also available in GitHub Actions artifacts for 30 days.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Build Summary
        if: always()
        run: |
          echo "## EAS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ steps.build-profile.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.build-meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ steps.build-meta.outputs.build-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.build-meta.outputs.short-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID:** ${{ steps.eas-build.outputs.build-id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Build Logs](${{ steps.eas-build.outputs.build-url }})" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.build-wait.outputs.artifact-url }}" ]; then
            echo "- [Download APK](${{ steps.build-wait.outputs.artifact-url }})" >> $GITHUB_STEP_SUMMARY
          fi
