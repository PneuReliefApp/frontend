name: EAS Build - Android APK

on:
  push:
    branches:
      - main

concurrency:
  group: eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Generate build metadata
        id: build-meta
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="${{ github.ref_name }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Update app version
        run: |
          VERSION="${{ steps.build-meta.outputs.version }}"
          BUILD_NUMBER="${{ steps.build-meta.outputs.build-number }}"

          node -e "
          const fs = require('fs');
          const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
          appJson.expo.version = '${VERSION}'.replace('v', '');
          appJson.expo.android.versionCode = parseInt('${BUILD_NUMBER}');
          fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
          "

      - name: Build Android APK with EAS
        id: eas-build
        run: |
          eas build \
            --platform android \
            --profile production \
            --non-interactive \
            --no-wait \
            --json > build-output.json

          BUILD_ID=$(cat build-output.json | jq -r '.[0].id')
          BUILD_URL=$(cat build-output.json | jq -r '.[0].logsUrl')
          echo "build-id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "build-url=${BUILD_URL}" >> $GITHUB_OUTPUT
          echo "::notice::Build started with ID: ${BUILD_ID}"
          echo "::notice::Build logs: ${BUILD_URL}"

      - name: Wait for build completion
        id: build-wait
        timeout-minutes: 30
        run: |
          BUILD_ID="${{ steps.eas-build.outputs.build-id }}"
          echo "Waiting for build ${BUILD_ID} to complete..."

          while true; do
            STATUS=$(eas build:view ${BUILD_ID} --json | jq -r '.status')
            echo "Current status: ${STATUS}"

            case ${STATUS} in
              "finished")
                echo "Build completed successfully!"
                ARTIFACT_URL=$(eas build:view ${BUILD_ID} --json | jq -r '.artifacts.buildUrl')
                echo "artifact-url=${ARTIFACT_URL}" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "errored"|"canceled")
                echo "::error::Build failed with status: ${STATUS}"
                exit 1
                ;;
              "in-queue"|"in-progress")
                echo "Build in progress, waiting 30 seconds..."
                sleep 30
                ;;
              *)
                echo "Unknown status: ${STATUS}"
                sleep 30
                ;;
            esac
          done

      - name: Download APK
        if: success()
        run: |
          ARTIFACT_URL="${{ steps.build-wait.outputs.artifact-url }}"
          APK_NAME="pneurelief-${{ steps.build-meta.outputs.version }}-${{ steps.build-meta.outputs.short-sha }}.apk"

          curl -L -o "${APK_NAME}" "${ARTIFACT_URL}"

          if [ -f "${APK_NAME}" ]; then
            SIZE=$(du -h "${APK_NAME}" | cut -f1)
            echo "::notice::APK downloaded successfully (${SIZE})"
          else
            echo "::error::Failed to download APK"
            exit 1
          fi

      - name: Upload APK to GitHub Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pneurelief-android-${{ steps.build-meta.outputs.version }}
          path: "*.apk"
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: "*.apk"
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        if: always()
        run: |
          echo "## EAS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.build-meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ steps.build-meta.outputs.build-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.build-meta.outputs.short-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID:** ${{ steps.eas-build.outputs.build-id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Build Logs](${{ steps.eas-build.outputs.build-url }})" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.build-wait.outputs.artifact-url }}" ]; then
            echo "- [Download APK](${{ steps.build-wait.outputs.artifact-url }})" >> $GITHUB_STEP_SUMMARY
          fi
